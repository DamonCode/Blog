# iOS å¤šçº¿ç¨‹ç¼–ç¨‹ï¼šä½¿ç”¨ NSOperation å’Œ GCD è¿›è¡Œå¤šçº¿ç¨‹ç¼–ç¨‹
åœ¨ iOS å¼€å‘ä¸­,å¹¶å‘é€šå¸¸è¢«è§†ä½œ"æ´ªæ°´çŒ›å…½"ã€‚è®¸å¤šå¼€å‘è€…è®¤ä¸ºè¿™æ˜¯"å±é™©åœ°å¸¦",å› æ­¤éƒ½æåŠ›é¿å…ä½¿ç”¨å®ƒã€‚ä¼ é—»å¤šçº¿ç¨‹ä»£ç åº”è¯¥å°½ä½ æ‰€èƒ½å»é¿å…ä½¿ç”¨ã€‚æˆ‘ä¹Ÿè®¤ä¸ºåœ¨ä½ æ²¡æœ‰å¾ˆå¥½æŒæ¡å¹¶å‘ç¼–ç¨‹çš„æ—¶å€™,è¿™çš„ç¡®æ˜¯ä¸€ä¸ª"å±é™©åœ°å¸¦"ã€‚å®ƒçš„ä¸å®‰å…¨æ¥æºäºä½ çš„æ— çŸ¥ã€‚æƒ³è±¡ä¸€ä¸‹,åœ¨äººä»¬çš„ä¸€ç”Ÿä¸­,ä¹Ÿè¦é¢ä¸´å¾ˆå¤šçš„å±é™©æ´»åŠ¨,ä¸æ˜¯ä¹ˆ?ä½†æ˜¯ä¸€æ—¦äººä»¬æŒæ¡äº†å®ƒ(æŠ€å·§),ä½ å°†èƒ½å¾ˆå¥½çš„ä½¿ç”¨å®ƒã€‚å¹¶å‘ç¼–ç¨‹æ‹¥æœ‰ä¸¤é¢æ€§,å› ä¸ºä½ åº”è¯¥æŒæ¡å¦‚ä½•å»ä½¿ç”¨å®ƒã€‚å®ƒå¸®åŠ©ä½ æ„å»ºå‡ºæœ‰æ‰§è¡Œæ•ˆç‡é«˜,å¿«é€Ÿçš„åº”ç”¨,åŒæ—¶,æ»¥ç”¨ä¹Ÿä¼šå¯¼è‡´æ˜¯ä½ çš„åº”ç”¨å´©æºƒã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¼€å§‹ä½¿ç”¨å¹¶å‘ç¼–ç¨‹æŠ€æœ¯ä¹‹å‰ä½ åº”è¯¥äº†è§£å“ªäº› API å¯ä»¥ç”¨æ¥è§£å†³é—®é¢˜ã€‚åœ¨iOS ä¸­æœ‰ä¸åŒçš„APIs å¯ä¾›ä½¿ç”¨ã€‚åœ¨è¿™ç¯‡æ•™ç¨‹ä¸­æˆ‘ä»¬å°†ä¼šä»‹ç»æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ä¸¤ç§ APIs ---- NSOperation å’Œ Dispatch Queuesã€‚ 
## ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¹¶å‘?
æˆ‘çŸ¥é“ä½ æ˜¯ä¸€ä¸ªæœ‰ä¸°å¯Œç»éªŒçš„ iOS å¼€å‘è€…ã€‚æ— è®ºä½ å°†è¦å¼€å‘ä»€ä¹ˆç±»å‹çš„ apps ,ä½ éƒ½éœ€è¦çŸ¥é“å¹¶å‘ç¼–ç¨‹å¯ä»¥æ˜¯ä½ çš„åº”ç”¨è¿è¡Œçš„æ›´å¿«æ›´é«˜æ•ˆã€‚ä»¥ä¸‹æˆ‘ç®€è¦åˆ—ä¸¾å‡ ä¸ªä½¿ç”¨å¹¶å‘çš„æœ‰ç‚¹:
* **å……åˆ†åˆ©ç”¨ iOS çš„ç¡¬ä»¶** : ç°åœ¨æ‰€æœ‰çš„ iOSè®¾å¤‡éƒ½æ‹¥æœ‰å¤šæ ¸å¤„ç†å™¨, è¿™å°±å…è®¸å¼€å‘è€…å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚æ‰€ä»¥ä½ åº”è¯¥å……åˆ†åˆ©ç”¨è¿™ä¸€ç‚¹(å¤šæ ¸å¤„ç†å™¨),å‘æŒ¥ç¡¬ä»¶çš„ä¼˜åŠ¿ã€‚
* **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**:æœ‰æ—¶å€™ä½ ä¼šå»è°ƒç”¨ç½‘ç»œæœåŠ¡,è¿›è¡Œä¸€äº› IO æ“ä½œ, æˆ–è€…æ‰§è¡Œä¸€äº›å…¶å®ƒç¹é‡çš„äº‹åŠ¡ã€‚å¦‚ä½ æ‰€çŸ¥, åœ¨ UI çº¿ç¨‹(main thread)åšè¿™äº›æ“ä½œå°†ä¼šé˜»å¡ä½ çš„åº”ç”¨, æ˜¯ç¨‹åºå¤±å»å“åº”ã€‚æ›¾ç»ç”¨æˆ·é¢å¯¹è¿‡è¿™ä¸ªé—®é¢˜,
ä»–ä¼šç«‹é©¬æ€æ‰åº”ç”¨è¿›ç¨‹ã€‚ä½¿ç”¨å¤šçº¿ç¨‹,æ‰€æœ‰è¿™äº›äº‹åŠ¡éƒ½å¯ä»¥åœ¨åå°çº¿ç¨‹å®Œæˆæ— éœ€é˜»å¡ä¸»çº¿ç¨‹ä»¥åŠå¦¨ç¢ç”¨æˆ·æ“ä½œã€‚ç”¨æˆ·å¯ä»¥åŒæ—¶ç‚¹å‡»æŒ‰é’®,æ»‘åŠ¨æ“ä½œåº”ç”¨ã€‚
* **NSOpetion å’Œ GCD çš„ APIs ä½¿å¾—å¤šçº¿ç¨‹ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•**:åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹æ˜¯ä¸€ä»¶ä¸å®¹æ˜“çš„ä»»åŠ¡ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°çš„å¼€å‘è€…å¬åˆ°å¤šçº¿ç¨‹ä»¥åŠå¹¶å‘çš„æ—¶å€™æ„Ÿåˆ°ææƒ§çš„åŸå› ã€‚åœ¨ iOS å¼€å‘ä¸­, æˆ‘ä»¬æœ‰å¾ˆå¤šä¼˜é›…æ˜“ç”¨çš„å¹¶å‘ APIsã€‚ä½ æ— é¡»å…³å¿ƒåº•å±‚å¦‚ä½•å®ç°åˆ›å»ºæˆ–è€…ç®¡ç†çº¿ç¨‹ã€‚è¿™äº› APIs å°†ä¼šä¸ºä½ åšå¥½ä¸€åˆ‡ã€‚å¦å¤–ä¸€ä¸ªé‡è¦çš„ä¼˜åŠ¿å°±æ˜¯,è¿™äº› APIs å¸®ä½ å®ŒæˆåŒæ­¥æ“ä½œæ¥é¿å…ç«æ€æ¡ä»¶çš„å‘ç”Ÿã€‚å½“å¤šçº¿ç¨‹æ“ä½œä¸€ä»½å…±äº«çš„æ•°æ®æ—¶å€™å¯èƒ½ä¼šå‘ç”Ÿç«æ€æ¡ä»¶,ä»è€Œå¯¼è‡´æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚é€šè¿‡ä½¿ç”¨synchronization æ¥ä¿æŠ¤åœ¨å¤šçº¿ç¨‹ä¹‹é—´å…±äº«çš„èµ„æºã€‚
## å…³äºå¹¶å‘ä½ åº”è¯¥çŸ¥é“å“ªäº›?
åœ¨æœ¬æ•™ç¨‹ä¸­, æˆ‘ä»¬å°†ä¼šå‘ä½ è§£é‡Šæ‰€æœ‰ä½ åº”è¯¥æŒæ¡ç†è§£ä»¥åŠå›°æƒ‘ä½ çš„çŸ¥è¯†ç‚¹ã€‚é¦–å…ˆæˆ‘æ¨èäº†è§£ blocks(Swiftä¸­çš„é—­åŒ…),å› ä¸ºåœ¨å¹¶å‘çš„ APIs ä¸­å¤§é‡ä½¿ç”¨åˆ°äº†ã€‚ç„¶åæˆ‘ä»¬å°†ä¼šè®²è§£ GCD å’Œ NSOpertionQueues ã€‚æˆ‘ä»¬å°†ä¼šè®²è§£ä»–ä»¬çš„æ¦‚å¿µ,ä¸åŒä»¥åŠå¦‚ä½•å»å®ç°ã€‚
## ç¬¬ä¸€éƒ¨åˆ†:GCD (Grand Central Dispatch)
GCD æœ€å¸¸ä½¿ç”¨ç”¨æ¥ç®¡ç†å¹¶å‘,æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„ API , GCD æä¾›ä»¥åŠç®¡ç†ç€ä»»åŠ¡é˜Ÿåˆ—ã€‚é¦–å…ˆ, è®©æˆ‘ä»¬æ¥çœ‹çœ‹éƒ½æœ‰å“ªäº›é˜Ÿåˆ—ã€‚
### é˜Ÿåˆ—æ˜¯ä»€ä¹ˆ?
é˜Ÿåˆ—æ˜¯ä¸€ç§ç®¡ç†å¯¹è±¡å…ˆå…¥å…ˆå‡º(FIFO)çš„æ•°æ®ç»“æ„ã€‚é˜Ÿåˆ—ç±»ä¼¼äºç”µå½±é™¢è´­ç¥¨çª—å£æ’é˜Ÿçš„äººç¾¤ã€‚ ç”µå½±ç¥¨ä»¥å…ˆåˆ°å…ˆè¢«æœåŠ¡çš„å½¢å¼è¿›è¡Œå”®å–ã€‚é˜Ÿåˆ—å‰è¾¹çš„äººæ¯”åè¾¹çš„äººå…ˆä¹°åˆ°ç¥¨ã€‚è®¡ç®—æœºä¸­é˜Ÿåˆ—ä¹Ÿæ˜¯ç±»ä¼¼çš„,å› ä¸ºå…ˆæ·»åŠ è¿›é˜Ÿåˆ—çš„å…ƒç´ é¦–å…ˆè¢«ç§»é™¤ã€‚
![](http://www.appcoda.com/wp-content/uploads/2015/10/queue-line-2-1166050-1280x960.jpg)
### Dispatch Queues
Dispatch Queues å¯ä»¥è®©ä½ åœ¨ä½ çš„åº”ç”¨ä¸­å¾ˆä¾¿æ·çš„ä½¿ç”¨å¼‚æ­¥ä»¥åŠå¹¶å‘ã€‚ä½ çš„åº”ç”¨ä»¥ blocks çš„å½¢å¼æ¥è°ƒç”¨è¿™äº›é˜Ÿåˆ—ã€‚æœ‰ä¸¤ç§å½¢å¼çš„ dispatch queuesï¼š(1)serial queue(ä¸²è¡Œé˜Ÿåˆ—)ï¼Œä»¥åŠ(2)concurrent queues(å¹¶å‘é˜Ÿåˆ—)ã€‚åœ¨è®¨è®ºä¸¤è€…çš„ä¸åŒä¹‹å‰ï¼Œäº¦éœ€è¦é¦–å…ˆçŸ¥é“ä»»åŠ¡è¢«åˆ†é…åœ¨å•ç‹¬çš„çº¿ç¨‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯åˆ›å»ºçº¿ç¨‹çš„çº¿ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡å¦‚ä½ åœ¨ä¸»çº¿ç¨‹åˆ›å»º dispatch queuesï¼Œè¿™äº›ä»»åŠ¡ä¼šåœ¨è¿è¡Œçš„å…¶ä»–çš„çº¿ç¨‹ä¸Šï¼Œè€Œä¸æ˜¯ä¸»çº¿ç¨‹ä¸Šã€‚
### Serial Queues
å½“ä½ é€‰æ‹©ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—ï¼Œè¿™ç§é˜Ÿåˆ—åªèƒ½åŒæ—¶æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚åœ¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šæŒ‰é¡ºåºæ‰§è¡Œã€‚ç„¶è€Œï¼Œä»–ä»¬ä¸å…³å¿ƒåœ¨å…¶ä»–çº¿ç¨‹ä¸Šçš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥ä½¿ç”¨å¤šä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥åˆ›å»ºä¸¤ä¸ªç©¿è¡Œé˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ªé˜Ÿåˆ—åŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯ä¸¤ä¸ªä»»åŠ¡(ä¸åŒçº¿ç¨‹ä¸Šçš„)å¯ä»¥åŒæ—¶è¢«æ‰§è¡Œ(å¹¶å‘)ã€‚
ä¸²è¡Œé˜Ÿåˆ—å¯¹äºç®¡ç†å…±äº«çš„èµ„æºæ¥è¯´ç®€ç›´å¤ªæ£’å•¦ï¼å¯¹äºå…±äº«çš„èµ„æºï¼Œå®ƒæä¾›äº†æŒ‰åºçš„ä¿éšœæ¥é¿å…"ç«æ€æ¡ä»¶"çš„å‘ç”Ÿã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæœ‰ä¸€å¤§ç¾¤è¦ä¹°ç”µå½±ç¥¨çš„äººï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªå”®ç¥¨å…ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå”®ç¥¨å‘˜å°±æ˜¯å…±äº«çš„èµ„æºã€‚ä¸€ä¸ªäººåŒæ—¶æœåŠ¡è¿™ä¹ˆå¤šäººç®€ç›´å¤ªç³Ÿäº†ã€‚ä¸ºäº†è§£å†³è¿™ç§çª˜å¢ƒï¼Œå°±è¦æ±‚ä¹°ç¥¨çš„æ’æˆä¸€ä¸ªé˜Ÿåˆ—(serial queue)ï¼Œä»¥ä¾¿å”®ç¥¨å‘˜åŒä¸€æ—¶é—´åªæœåŠ¡ä¸€ä¸ªäººã€‚
å†æ¬¡å¼ºè°ƒï¼Œè¿™å¹¶ä¸æ„å‘³ç€ç”µå½±é™¢åŒæ—¶åªèƒ½æœåŠ¡ä¸€ä¸ªäººã€‚å¦‚æœæ–°å¼€æ”¾äº†ä¸¤ä¸ªçš„æŸœå°ï¼Œé‚£ä¹ˆå°±å¯ä»¥åŒæ—¶æœåŠ¡ä¸‰ä¸ªé¡¾å®¢ã€‚è¿™å°±æ˜¯æ‰€è¯´çš„é€šè¿‡ä½¿ç”¨å¤šä¸ªä¸²è¡Œé˜Ÿåˆ—æ¥å®ç°åŒæ—¶å¯ä»¥æ‰§è¡Œå¤šä»»åŠ¡ã€‚
ä¸²è¡Œé˜Ÿåˆ—çš„ä¼˜åŠ¿ï¼š
 1.  å¯¹å…±äº«èµ„æºæœ‰åºçš„è®¿é—®å¯ä»¥é¿å…"ç«æ€æ¡ä»¶";
 2.  ä»»åŠ¡åœ¨å¯æ§çš„ç§©åºä¸‹æ‰§è¡Œã€‚å½“ä½ é€’äº¤ä¸€ä¸ªä»»åŠ¡åˆ°ä¸²è¡Œé˜Ÿåˆ—ï¼Œå®ƒä»¬å°†ä¼šæŒ‰ç…§ä½ æ·»åŠ çš„é˜Ÿåˆ—è¢«æ‰§è¡Œã€‚
 3.  ä½ å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„ä¸²è¡Œé˜Ÿåˆ—ã€‚
 ### Concurrent Queues
 æ­£å¦‚åå­—ä¸€æ ·ï¼Œå¹¶å‘é˜Ÿåˆ—å…è®¸åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚ä»»åŠ¡åœ¨ä»–ä»¬è¢«æ·»åŠ åˆ°çš„é˜Ÿåˆ—ä¸Šæœ‰åºæ‰§è¡Œã€‚ä½†æ˜¯ä»–ä»¬çš„æ‰§è¡Œå¯ä»¥åŒæ—¶è¿›è¡Œå¹¶ä¸”æ— éœ€ç­‰å¾…å…¶ä»–ä»»åŠ¡ç›´æ¥æ‰§è¡Œã€‚å¹¶å‘é˜Ÿåˆ—ä»¥åŒä¸€ä¸ªæ¬¡åºä¸‹æ‰§è¡Œï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“æ‰§è¡Œçš„å…·ä½“æ¬¡åºï¼Œæ‰§è¡Œæ—¶é—´ä»¥åŠæœ‰å‡ ä¸ªä»»åŠ¡åœ¨åŒæ—¶æ‰§è¡Œã€‚
 ä¸¾ä¸ªæ —å­ï¼Œå¹¶å‘é˜Ÿåˆ—æ‰§è¡Œä¸‰ä¸ªä»»åŠ¡(ä»»åŠ¡#1ï¼Œä»»åŠ¡#2ï¼Œä»»åŠ¡#3)ã€‚è¿™äº›ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ä»¥ä»–ä»¬æ·»åŠ çš„é¡ºåºåŒæ—¶æ‰§è¡Œï¼Œç„¶è€Œï¼Œæ‰§è¡Œæ—¶é—´ä»¥åŠç»“æŸæ—¶é—´æ˜¯ä¸åŒçš„ã€‚å³æ—¶#2å’Œ#3ä»»åŠ¡å¼€å§‹è€—è´¹äº†ä¸€äº›æ—¶é—´ï¼Œä»–ä»¬ä¾ç„¶å¯ä»¥å…ˆäº#1ä»»åŠ¡å®Œæˆã€‚è¿™æ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥å†³å®šçš„ã€‚
 ### ä½¿ç”¨é˜Ÿåˆ—
 ç°åœ¨æˆ‘ä»¬å·²ç»è§£é‡Šäº†ä¸²è¡Œå’Œå¹¶è¡Œé˜Ÿåˆ—ï¼Œè¯¥äº†è§£å¦‚ä½•ä½¿ç”¨å®ƒä»¬äº†ï¼ç³»ç»Ÿç»™æ¯ä¸€ä¸ªåº”ç”¨é»˜è®¤æä¾›ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä»¥åŠå››ä¸ªå¹¶è¡Œé˜Ÿåˆ—ã€‚ä¸»é˜Ÿåˆ—æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šå…¨å±€å¯ç”¨çš„ä¸²è¡Œé˜Ÿåˆ—;å®ƒè¢«ç”¨æ¥æ›´æ–° app UI ä»¥åŠå’Œ UIView æ›´æ–°ç›¸å…³çš„æ“ä½œã€‚ä¸»é˜Ÿåˆ—åªèƒ½åŒæ—¶æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œç¹é‡çš„ä»»åŠ¡ä¼šé˜»å¡ä½ çš„ UI æ“ä½œã€‚
 é™¤äº†ä¸»é˜Ÿåˆ—, ç³»ç»Ÿè¿˜æä¾›äº†å››ä¸ªå¹¶å‘é˜Ÿåˆ—ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º `Global Dispatch     Queue` ã€‚è¿™äº›é˜Ÿåˆ—åœ¨åº”ç”¨ç¨‹å¼ä¸­æ˜¯å…¨å±€çš„ï¼Œå¹¶ä¸”åªåœ¨ä¼˜å…ˆçº§ä¸Šæœ‰åŒºåˆ«ã€‚ä½¿ç”¨è¿™äº›å…¨   å±€é˜Ÿåˆ—ï¼Œä½ éœ€è¦ä½¿ç”¨ä»¥ä¸‹å€¼æ¥æŒ‡å®š `dispatch_get_global_queue` çš„ç¬¬ä¸€ä¸ªå‚æ•°:
* `DISPATCH_QUEUE_PRIORITY_HIGH`
* `DISPATCH_QUEUE_PRIORITY_DEFAULT`
* `DISPATCH_QUEUE_PRIORITY_LOW`
* `DISPATCH_QUEUE_PRIORITY_BACKGROUND`
è¿™äº›é˜Ÿåˆ—ç±»å‹ç›¸å½“äºæ‰§è¡Œçš„ä¼˜å…ˆçº§ã€‚HIGH å…·å¤‡æœ€é«˜ä¼˜å…ˆçº§ï¼ŒBACKGROUND æ‹¥æœ‰æœ€ä½çš„ä¼˜å…ˆçº§ã€‚å› æ­¤ä½ å¯ä»¥ä»¥æ­¤æ¥å†³å®šä½ æ‰€ä½¿ç”¨çš„é˜Ÿåˆ—çš„ä¼˜å…ˆçº§ã€‚åŒæ—¶è¯·æ³¨æ„ï¼Œè¿™äº›é˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯ Apple çš„ APISï¼Œå› æ­¤è¿™äº›é˜Ÿåˆ—æ‰§è¡Œçš„ä¸ä»…åªæœ‰ä½ çš„ä»»åŠ¡ã€‚
æ€»ç»“, ä½ å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„ä¸²è¡Œæˆ–è€…å¹¶è¡Œé˜Ÿåˆ—ã€‚åœ¨ä½¿ç”¨å¹¶å‘é˜Ÿåˆ—çš„æ—¶å€™ï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½¿ç”¨ç³»ç»Ÿæä¾›çš„å››ç§å…¨å±€é˜Ÿåˆ—ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥åˆ›å»ºä½ è‡ªå·±çš„é˜Ÿåˆ—ã€‚

## CGD å›¾è¡¨
ç°åœ¨ä½ åº”è¯¥å¯¹ `dispatch queue` æœ‰äº†åˆæ­¥çš„ç†è§£ã€‚ç°åœ¨, æˆ‘å°†ä¼šç»™ä½ ä¸€ä¸ªç®€å•çš„å›¾è¡¨ä¾›ä½ å‚è€ƒã€‚è¿™ä¸ªè¡¨æ ¼å¾ˆç®€å•, åŒ…å«äº†æ‰€æœ‰ä½ éœ€è¦äº†è§£å…³äº GCD çš„çŸ¥è¯†ç‚¹ã€‚
![](http://www.appcoda.com/wp-content/uploads/2015/10/gcd-cheatsheet.png)

éå¸¸ coolï¼Œå¯¹å§ï¼Ÿç°åœ¨è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„ demo æ¥äº†è§£å¦‚ä½•ä½¿ç”¨ dispatch queues ã€‚æˆ‘å°†ä¼šå±•ç¤ºç»™ä½ å¦‚ä½•ä½¿ç”¨ dispatch queues æ¥ä¼˜åŒ–ä¸€ä¸ª app çš„æ€§èƒ½ ä½¿å¾—å…¶å“åº”æ›´å¿«ã€‚
## Demo Project
æˆ‘ä»¬çš„å¯åŠ¨é¡¹ç›®éå¸¸çš„ç®€å•ï¼Œæˆ‘ä»¬å±•ç¤ºå››ä¸ª image views ,æ¯ä¸€ä¸ªä»æŒ‡å®šç«™ç‚¹è¯·æ±‚ä¸€ä¸ªå›¾ç‰‡ã€‚å›¾ç‰‡è¯·æ±‚åœ¨ä¸»çº¿ç¨‹å®Œæˆã€‚ä¸ºäº†å±•ç¤ºç»™ä½  UI æ˜¯å¦‚ä½•çš„å“åº”, æˆ‘å·²ç»æ·»åŠ äº†ç®€å•çš„ slider åœ¨å›¾ç‰‡ä¸‹è¾¹ã€‚ç°åœ¨ [ä¸‹è½½å¹¶è¿è¡Œé¡¹ç›®](https://www.dropbox.com/s/lkiasutevec5vx0/ConcurrencyDemoStarter.zip?dl=0)ã€‚ç‚¹å‡» Start æŒ‰é’®æ¥å¼€å§‹ä¸‹è½½å›¾ç‰‡,ç„¶åæ‹–åŠ¨ slider å½“å›¾ç‰‡ä¸‹è½½çš„æ—¶å€™ã€‚ä½ å°†ä¼šå‘ç° slider æ‹–ä¸åŠ¨ã€‚
![](http://www.appcoda.com/wp-content/uploads/2015/10/concurrency-demo.png)
åœ¨ä½ ç‚¹å‡»äº†å¼€å§‹æŒ‰é’®å, å›¾ç‰‡åœ¨ä¸»çº¿ç¨‹å¼€å§‹çå­å•Šã€‚æ˜¾è€Œæ˜“è§, è¿™ç§åšæ³•éå¸¸å¯æ€•, å¹¶ä¸”ä½¿å¾— UI æ— å“åº”ã€‚ä¸å¹¸çš„æ˜¯, æ—¶è‡³ä»Šæ—¥ï¼Œä»ç„¶æœ‰å¾ˆå¤š app åœ¨ä¸»çº¿åšè®¸å¤šç¹é‡çš„åŠ è½½ä»»åŠ¡ã€‚ç°åœ¨è®©æˆ‘ä»¬ä¸€èµ·æ¥ä½¿ç”¨ dispatch queues æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜å§!
é¦–å…ˆ, æˆ‘ä»¬å°†è¦ä½¿ç”¨å¹¶å‘é˜Ÿåˆ—ç„¶åå†ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—æ¥å®ç°è§£å†³æ–¹æ¡ˆã€‚
### ä½¿ç”¨å¹¶å‘é˜Ÿåˆ—
å…ˆåœ¨ Xcode ä¸­æ‰“å¼€ `ViewController.swift`ã€‚å¦‚æœä½ ä»”ç»†çœ‹äº†ä»£ç çš„è¯ï¼Œä½ ä¼šçœ‹åˆ° `didClickOnStart` æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è¿›è¡Œäº†å›¾ç‰‡ä¸‹è½½ã€‚æˆ‘ä»¬ç°åœ¨æ‰§è¡Œä»»åŠ¡å¦‚ä¸‹æ‰€ç¤ºï¼š
    
    @IBAction func didClickOnStart(sender: AnyObject) {
        let img1 = Downloader.downloadImageWithURL(imageURLs[0])
        self.imageView1.image = img1
    
        let img2 = Downloader.downloadImageWithURL(imageURLs[1])
        self.imageView2.image = img2
    
        let img3 = Downloader.downloadImageWithURL(imageURLs[2])
        self.imageView3.image = img3
    
        let img4 = Downloader.downloadImageWithURL(imageURLs[3])
        self.imageView4.image = img4
    }
æ¯ä¸€ä¸ª downloader éƒ½è¢«è§†ä½œä¸€ä¸ªä»»åŠ¡,æ‰€æœ‰çš„ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œã€‚ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨å…¨å±€å¹¶å‘é˜Ÿåˆ—ä¸­çš„ Default çº§åˆ«çš„é˜Ÿåˆ—ã€‚

    let queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT,0)
        disptach_asnc(queue) {() -> Void in
            let img1 = Downloader.downloadImageWithURL(imageURLS[0])
            dispatch_asnc(dispatch_get_main_queue(),{
                self.imageView1.image = img1
            })
        }
æˆ‘ä»¬é¦–å…ˆé€šè¿‡ `dispatch_get_global_queue` æ¥è°ƒç”¨é»˜è®¤çº§åˆ«çš„å¹¶å‘é˜Ÿåˆ—, ç„¶ååœ¨ block é‡Œè¾¹æˆ‘ä»¬é€’äº¤äº†ä¸‹è½½ç¬¬ä¸€ä¸ªå›¾ç‰‡çš„ä»»åŠ¡ã€‚å½“å›¾ç‰‡ä¸‹è½½å®Œæˆå,æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œäº†ä½¿ç”¨ä¸‹è½½çš„å›¾ç‰‡æ›´æ–° image viewçš„ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´,æˆ‘ä»¬æŠŠä¸‹è½½ä»»åŠ¡æ”¾åœ¨ä¸€ä¸ªåå°çº¿ç¨‹ä¸­,ä½†æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ UI æ“ä½œã€‚
å¦‚æœä½ å‰©ä½™çš„å›¾ç‰‡è¿›è¡Œäº†åŒæ ·çš„æ“ä½œ,ä½ çš„ä»£ç åº”è¯¥å’Œä¸‹è¾¹ä¸€æ ·:
        @IBAction func didClickOnStart(sender: AnyObject) {
        
        let queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0)
        dispatch_async(queue) { () -> Void in
            
            let img1 = Downloader.downloadImageWithURL(imageURLs[0])
            dispatch_async(dispatch_get_main_queue(), {
                
                self.imageView1.image = img1
            })
            
        }
        dispatch_async(queue) { () -> Void in
            
            let img2 = Downloader.downloadImageWithURL(imageURLs[1])
            
            dispatch_async(dispatch_get_main_queue(), {
                
                self.imageView2.image = img2
            })
            
        }
        dispatch_async(queue) { () -> Void in
            
            let img3 = Downloader.downloadImageWithURL(imageURLs[2])
            
            dispatch_async(dispatch_get_main_queue(), {
                
                self.imageView3.image = img3
            })
            
        }
        dispatch_async(queue) { () -> Void in
            
            let img4 = Downloader.downloadImageWithURL(imageURLs[3])
            
            dispatch_async(dispatch_get_main_queue(), {
                
                self.imageView4.image = img4
            })
        }
        
    }
ç°åœ¨ä½ å·²ç»æŠŠå››ä¸ªå›¾ç‰‡ä¸‹è½½ä»»åŠ¡æ”¾åœ¨äº†ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—é‡Œã€‚ç„¶åç¼–è¯‘è¿è¡Œä½ çš„ app ,ä»–åº”è¯¥è¿è¡Œçš„å¾ˆå¿«(å¦‚æœè·‘å‡ºäº†å¼‚å¸¸,ä½ åº”è¯¥æ£€æŸ¥ä½ çš„ä»£ç æ˜¯å¦å’Œä¸Šè¾¹ä¸€æ ·)ã€‚æ³¨æ„åˆ°äº†å—?å½“ä½ åœ¨ä¸‹è½½å›¾ç‰‡çš„æ—¶å€™,ä½ ä¾ç„¶å¯ä»¥å¾ˆé¡ºç•…çš„æ‹–æ‹½ slider ã€‚
### ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—
è§£å†³é˜»å¡çš„å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—ã€‚ç°åœ¨åŒæ ·å®šä½åˆ° ViewController.swift çš„ `didClickOnStart` æ–¹æ³•ã€‚è¿™æ¬¡æˆ‘ä»¬å°†ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—æ¥ä¸‹è½½å›¾ç‰‡ã€‚å½“ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—çš„æ—¶å€™,ä½ åº”å½“æ³¨æ„ä½ åº”è¯¥ä½¿ç”¨å“ªä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ª app éƒ½æœ‰ä¸€ä¸ªé»˜è®¤çš„ä¸²è¡Œé˜Ÿåˆ—, ä¹Ÿå°±æ˜¯è¿›è¡Œ UI æ“ä½œçš„ä¸»é˜Ÿåˆ—ã€‚æ‰€ä»¥è®°å¾—åœ¨ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—çš„æ—¶å€™,åº”è¯¥åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸²è¡Œé˜Ÿåˆ—ã€‚å¦åˆ™ä½ å°†ä¼šåœ¨ä½ çš„ app æ›´æ–° UI çš„æ—¶å€™æ‰§è¡Œä»»åŠ¡,è¿™å°†ä¼šå¯¼è‡´æ¯æ‰ç”¨æˆ·ä½“éªŒã€‚ä½ å¯ä»¥ä½¿ç”¨ `dispatch_queue_create` æ¥åˆ›å»ºæ–°çš„é˜Ÿåˆ—ç„¶ååƒä¹‹å‰æˆ‘ä»¬çš„æ“ä½œä¸€æ ·æ¥æ‰§è¡Œä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤º:
    @IBAction func didClickOnStart(sender: AnyObject) {
        
        let serialQueue = dispatch_queue_create("com.appcoda.imagesQueue", DISPATCH_QUEUE_SERIAL)
        
        
        dispatch_async(serialQueue) { () -> Void in
            
            let img1 = Downloader .downloadImageWithURL(imageURLs[0])
            dispatch_async(dispatch_get_main_queue(), {
                
                self.imageView1.image = img1
            })
            
        }
        dispatch_async(serialQueue) { () -> Void in
            
            let img2 = Downloader.downloadImageWithURL(imageURLs[1])
            
            dispatch_async(dispatch_get_main_queue(), {
                
                self.imageView2.image = img2
            })
            
        }
        dispatch_async(serialQueue) { () -> Void in
            
            let img3 = Downloader.downloadImageWithURL(imageURLs[2])
            
            dispatch_async(dispatch_get_main_queue(), {
                
                self.imageView3.image = img3
            })
            
        }
        dispatch_async(serialQueue) { () -> Void in
            
            let img4 = Downloader.downloadImageWithURL(imageURLs[3])
            
            dispatch_async(dispatch_get_main_queue(), {
                
                self.imageView4.image = img4
            })
        }
        
    }
æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ä¸€æ ·, å¹¶è¡Œé˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—åªæœ‰åˆ›å»ºæ–¹å¼ä¸åŒã€‚å½“æˆ‘ä»¬å†æ¬¡è¿è¡Œæˆ‘ä»¬çš„ app,å›¾ç‰‡ä¾ç„¶åœ¨åå°çº¿ç¨‹ä¸‹è½½,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ“ä½œæˆ‘ä»¬ UIã€‚
ä½†æ˜¯,è¯·æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹:
1.  è¿™ä¼šæ¯”å¹¶å‘é˜Ÿåˆ—è€—æ—¶æ›´å¤š,å› ä¸ºæˆ‘ä»¬åŒä¸€æ—¶é—´åªä¸‹è½½äº†ä¸€å¼ å›¾ç‰‡ã€‚æ¯ä¸€ä¸ªä»»åŠ¡éƒ½åœ¨ç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡çš„ç»“æŸã€‚
2.  å›¾ç‰‡ä»¥ image1, image2, image3, image4çš„é¡ºåºä¸‹è½½ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—,åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œã€‚
## ç¬¬äºŒéƒ¨åˆ†: Operation Queues
GCD æ˜¯å¼€å‘è€…å¯ä»¥å¹¶å‘æ‰§è¡Œä»»åŠ¡çš„åº•å±‚ C APIã€‚Operation queues,æ˜¯å»ºç«‹ GCD ä¹‹ä¸Šçš„é«˜çº§æŠ½è±¡é˜Ÿåˆ—æ¨¡å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åƒ GCD é‚£æ ·å¹¶å‘æ‰§è¡Œä»»åŠ¡,ä½†æ˜¯æ˜¯ä»¥é¢å‘å¯¹è±¡çš„æ–¹å¼ã€‚ç®€è€Œè¨€ä¹‹, Operation queues æ˜¯çš„å¼€å‘è€…æ›´åŠ è½»æ¾ ;)ã€‚
ä¸åƒ GCD é‚£æ ·, Operation Queues ä¸éµå¾ª FIFO çš„è§„åˆ™ã€‚ä»¥ä¸‹åˆ—ä¸¾å‡ ç‚¹ operation queues å’Œ dispatch queues ä¹‹é—´çš„ä¸åŒç‚¹:
1.  ä¸éµå¾ª FIFO: åœ¨ operation queues ä¸­,ä½ å¯ä»¥è®¾ç½®ä»»åŠ¡æ‰§è¡Œçš„ä¼˜å…ˆçº§,ä¹Ÿå¯ä»¥æ·»åŠ ä»»åŠ¡é—´çš„ä¾èµ–å…³ç³»,è¿™æ„å‘³ç€ä½ å¯ä»¥å®šä¹‰ä¸€äº›ä»»åŠ¡åœ¨åˆ«çš„ä»»åŠ¡ä¹‹åã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒä¸éµå¾ª FIFO çš„åŸå› ã€‚
2.  é»˜è®¤æƒ…å†µä¸‹,å®ƒä»¬æ˜¯å¹¶å‘æ‰§è¡Œçš„:è™½ç„¶ä½ ä»¬ä½¿ä»–ä»¬å˜ä¸ºä¸²è¡Œé˜Ÿåˆ—,ä½†æ˜¯ä½ ä»ç„¶å¯ä»¥é€šè¿‡è®¾ç½®ä»»åŠ¡ä¾èµ–å…³ç³»æ¥å®ç°ã€‚
3.  Operation queues æ˜¯ `NSOperationQueue` çš„å®ä¾‹, åŒæ—¶ä»»åŠ¡æ˜¯ `NSOpreation` çš„å®ä¾‹ã€‚

### NSOperation
operation queues é‡Œçš„ä»»åŠ¡æ˜¯ä»¥ `NSOpreation`å®ä¾‹çš„å½¢å¼è¿›è¡Œé€’äº¤ã€‚æˆ‘ä»¬è®¨è®ºè¿‡åœ¨ GCD ä¸­ä»»åŠ¡æ˜¯ä»¥ block çš„å½¢å¼é€’äº¤çš„,åŒæ ·ä¹Ÿå¯ä»¥åœ¨è¿™å„¿ä½¿ç”¨,ä½†æ˜¯å¿…é¡»å’Œ [NSOperation](https://developer.apple.com/documentation/foundation/operation) å®ä¾‹ä¸€èµ·ä½¿ç”¨ã€‚ä½ å¯ä»¥ç®€å•çš„æŠŠ NSOperation çœ‹åšä¸€ä¸ªå·¥ä½œå•å…ƒã€‚
NSOperation æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»,æ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨,å–è€Œä»£ä¹‹çš„æ˜¯å®ƒçš„å­ç±»ã€‚åœ¨ iOS SDK ä¸­,æä¾›äº†ä¸¤ç§ NSOperation çš„å­ç±»ã€‚è¿™äº›ç±»å¯ä»¥ç›´æ¥è¢«ä½¿ç”¨,ä½†æ˜¯ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¸€ä¸ª NSOperation çš„å­ç±»æ¥æ‰§è¡Œä»»åŠ¡ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ä¸¤ä¸ªç±»å¦‚ä¸‹:
1. **NSBlockOperation** - é€šè¿‡è¿™ä¸ªç±»,ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª blocks æ¥åˆå§‹åŒ–ä»»åŠ¡ã€‚ä»»åŠ¡æœ¬èº«å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª block,å½“æ‰€æœ‰çš„ block æ‰§è¡Œå®Œæ¯•æˆ‘ä»¬å¯ä»¥è®¤ä¸ºä»»åŠ¡æ‰§è¡Œç»“æŸã€‚
2. **NSInvocationOperation** - ä½¿ç”¨è¿™ä¸ªæ¥åˆå§‹åŒ–ä¸€ä¸ªä»»åŠ¡,ä½¿å¾—æŒ‡å®šçš„å¯¹è±¡æ‰§è¡Œä¸€ä¸ª selectorã€‚

NSOperation çš„ä¼˜åŠ¿æœ‰å“ªäº›?
1. é¦–å…ˆ,NSOperation æ”¯æŒæ·»åŠ ä¾èµ–å…³ç³»,é€šè¿‡ä½¿ç”¨` addDependency(op:NSOperation)` æ–¹æ³•ã€‚å½“ä½ æ‰§è¡Œä¸€ä¸ªä¾èµ–å…¶ä»–ä»»åŠ¡çš„ä»»åŠ¡æ—¶,ä½ åº”è¯¥ä½¿ç”¨ NSOperationã€‚
![](http://www.appcoda.com/wp-content/uploads/2015/10/NSOperation-Fig2.png)
2. å…¶æ¬¡,å¯ä»¥é€šè¿‡è®¾ç½® ä»¥ä¸‹å‡ ç§ `queuePriority` æ¥æ”¹å˜ä»»åŠ¡æ‰§è¡Œçš„ä¼˜å…ˆçº§:

        public enum NSOperationQueuePriority : Int {
            case VeryLow
            case Low
            case Normal
            case High
            case VeryHigh
        }

hight priority çš„ä»»åŠ¡å°†ä¼šè¢«é¦–å…ˆæ‰§è¡Œã€‚

3. å¯ä»¥å–æ¶ˆä»»æ„é˜Ÿåˆ—ä¸­æŒ‡å®šçš„ä»»åŠ¡æˆ–è€…æ‰€æœ‰çš„ä»»åŠ¡ã€‚ä»»åŠ¡å¯ä»¥åœ¨è¢«åŠ å…¥åˆ°é˜Ÿåˆ—åè¿›è¡Œå–æ¶ˆã€‚åœ¨ NSOperation ç±»ä¸­åªéœ€è¦è°ƒç”¨ `cancel()` å³å¯å–æ¶ˆä»»åŠ¡ã€‚å½“ä½ å–æ¶ˆäº†ä»»æ„çš„ä»»åŠ¡,ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¼šæœ‰ä¸€ç§å‘ç”Ÿ:
    - ä½ çš„ä»»åŠ¡å·²ç»å®Œæˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹,å–æ¶ˆæ“ä½œæ²¡æœ‰ä»»ä½•ååº”ã€‚
    - ä»»åŠ¡å·²ç»åœ¨æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹,ç³»ç»Ÿä¼šå¼ºåˆ¶åœæ­¢ä½ çš„ä»»åŠ¡, cacelled å±æ€§å°†ä¼šè¢«è®¾ç½®ä¸º `true`ã€‚
    - ä½ çš„ä»»åŠ¡è¿˜åœ¨ç­‰å¾…è¢«æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹,ä½ çš„ä»»åŠ¡ä¸ä¼šè¢«æ‰§è¡Œã€‚

4. NSOperation æœ‰ä¸‰ä¸ªå¾ˆæœ‰ç”¨çš„å±æ€§: finished, cancelledä»¥åŠ readyã€‚å½“ä»»åŠ¡æ‰§è¡Œå®Œæˆå finished å±æ€§ä¼šè¢«è®¾ç½®ä¸º trueã€‚cancelled å±æ€§ä¼šåœ¨ä»»åŠ¡å–æ¶ˆçš„æ—¶å€™è¢«è®¾ç½®ä¸º trueã€‚ready ä¼šåœ¨ä»»åŠ¡ç­‰å¾…è¢«æ‰§è¡Œçš„æ—¶å€™è¢«è®¾ä¸º trueã€‚
5. ä»»ä½•çš„ NSOperation éƒ½å¯ä»¥è®¾ç½®ä¸€ä¸ªå®Œæˆçš„å›è°ƒ (completion block)ã€‚å½“ finished å±æ€§è¢«è®¾ä¸º true çš„æ—¶å€™è¿™ä¸ª block å°†è¢«æ‰§è¡Œã€‚

ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨ NSOperation æ¥é‡å†™æˆ‘ä»¬çš„ demoã€‚é¦–å…ˆåœ¨ Viewcontroller ä¸­å£°æ˜ä¸€ä¸‹å˜é‡:
 
    `var queue = NSOperationQueue()`

æ¥ç€,ç”¨ä»¥ä¸‹ä»£ç æ¥å–ä»£ `didClickOnStart` æ–¹æ³•,å¹¶è§‚å¯Ÿæˆ‘ä»¬åœ¨ NSOperationQueue ä¸­å¦‚ä½•æ“ä½œä»»åŠ¡:

    @IBAction func didClickOnStart(sender: AnyObject) {
        queue = NSOperationQueue()
    
        queue.addOperationWithBlock { () -> Void in
            
            let img1 = Downloader.downloadImageWithURL(imageURLs[0])
    
            NSOperationQueue.mainQueue().addOperationWithBlock({
                self.imageView1.image = img1
            })
        }
        
        queue.addOperationWithBlock { () -> Void in
            let img2 = Downloader.downloadImageWithURL(imageURLs[1])
            
            NSOperationQueue.mainQueue().addOperationWithBlock({
                self.imageView2.image = img2
            })
    
        }
        
        queue.addOperationWithBlock { () -> Void in
            let img3 = Downloader.downloadImageWithURL(imageURLs[2])
            
            NSOperationQueue.mainQueue().addOperationWithBlock({
                self.imageView3.image = img3
            })
    
        }
        
        queue.addOperationWithBlock { () -> Void in
            let img4 = Downloader.downloadImageWithURL(imageURLs[3])
            
            NSOperationQueue.mainQueue().addOperationWithBlock({
                self.imageView4.image = img4
            })
    
        }
    }


æ­£å¦‚ä»¥ä¸Šä½ çœ‹åˆ°çš„, ä½¿ç”¨`addOperationWithBlock` æ–¹æ³•ç»™å®šçš„ block(swift ä¸­çš„é—­åŒ…)æ¥åˆ›å»ºæ–°çš„ä»»åŠ¡ã€‚å¾ˆç®€å•,ä¸æ˜¯ä¹ˆ?åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡,GCD ä¸­æˆ‘ä»¬ä½¿ç”¨ dispatch_async(),è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `NSOperationQueue.mainQueue()` å–è€Œä»£ä¹‹ã€‚
ä½ å¯ä»¥æµ‹è¯•è¿è¡Œä¸€ä¸‹ demo, å¦‚æœä»£ç è¿è¡Œæ­£å¸¸, app åº”è¯¥ä¼šåœ¨åå°çº¿ç¨‹ä¸‹è½½å›¾ç‰‡ä¸ä¼šé˜»å¡ UI æ“ä½œã€‚
åœ¨ä¸Šä¸€ä¸ªä¾‹å­ä¸­,æˆ‘ä»¬ä½¿ç”¨`addOperationWithBlock` æ¥å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä½¿ç”¨`NSBlockOperation` æ¥å®ç°åŒæ ·çš„æ“ä½œ,ä½†æ˜¯åŒæ—¶æˆ‘ä»¬æœ‰æ›´å¤šå¯é€‰æ‹©çš„(æ¯”å¦‚ completing handler)blockã€‚`didClickOnStart` æ–¹æ³•é‡å†™å¦‚ä¸‹:

    @IBAction func didClickOnStart(sender: AnyObject) {
        
        queue = NSOperationQueue()
        let operation1 = NSBlockOperation(block: {
            let img1 = Downloader.downloadImageWithURL(imageURLs[0])
            NSOperationQueue.mainQueue().addOperationWithBlock({
                self.imageView1.image = img1
            })
        })
        
        operation1.completionBlock = {
            print("Operation 1 completed")
        }
        queue.addOperation(operation1)
        
        let operation2 = NSBlockOperation(block: {
            let img2 = Downloader.downloadImageWithURL(imageURLs[1])
            NSOperationQueue.mainQueue().addOperationWithBlock({
                self.imageView2.image = img2
            })
        })
        
        operation2.completionBlock = {
            print("Operation 2 completed")
        }
        queue.addOperation(operation2)
        
        
        let operation3 = NSBlockOperation(block: {
            let img3 = Downloader.downloadImageWithURL(imageURLs[2])
            NSOperationQueue.mainQueue().addOperationWithBlock({
                self.imageView3.image = img3
            })
        })
        
        operation3.completionBlock = {
            print("Operation 3 completed")
        }
        queue.addOperation(operation3)
        
        let operation4 = NSBlockOperation(block: {
            let img4 = Downloader.downloadImageWithURL(imageURLs[3])
            NSOperationQueue.mainQueue().addOperationWithBlock({
                self.imageView4.image = img4
            })
        })
        
        operation4.completionBlock = {
            print("Operation 4 completed")
        }
        queue.addOperation(operation4)
    }

å¯¹äºæ¯ä¸€ä¸ªä»»åŠ¡,æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„`NSBlockOperation`å®ä¾‹æ¥æŠŠä»»åŠ¡åŒ…å«åœ¨ä¸€ä¸ª block é‡Œã€‚ç°åœ¨å½“ä»»åŠ¡å®Œæˆåæœ, completion handler å°†ä¼šè¢«è°ƒç”¨ã€‚æ–¹ä¾¿èµ·è§,æˆ‘ä»¬å°†ä¼šåœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰“å°ä¸€ä¸ªç®€çŸ­çš„æç¤ºã€‚å¦‚æœè¿è¡Œ demo, ä½ å°†ä¼šåœ¨æ§åˆ¶å°çœ‹è§å¦‚ä¸‹æç¤º:

    Operation 1 completed
    Operation 3 completed
    Operation 2 completed
    Operation 4 completed

### å–æ¶ˆä»»åŠ¡
æ­£å¦‚ä¹‹å‰æ‰€æåŠçš„,`NSBlockOperation` å…è®¸ä½ æ¥ç®¡ç†ä»»åŠ¡ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å–æ¶ˆä»»åŠ¡ã€‚é¦–å…ˆ,æˆ‘ä»¬åœ¨å¯¼èˆªæ æ·»åŠ ä¸€ä¸ªå«åš Cancle çš„æŒ‰é’®ã€‚ä¸ºäº†å®ç°å–æ¶ˆæ“ä½œ,æˆ‘ä»¬å°†ä¼šåœ¨ä»»åŠ¡#2å’Œä»»åŠ¡#1æ·»åŠ ä¾èµ–å…³ç³»,å¹¶ä¸”åœ¨ä»»åŠ¡#2å’Œä»»åŠ¡#3å¤©å‡ä¾èµ–å…³ç³»,è¿™æ„å‘³ç€#2å°†ä¼šåœ¨#1å®Œæˆåå¼€å§‹,#3ä¼šåœ¨#2å®Œæˆåå¼€å§‹ã€‚ä»»åŠ¡#4æ²¡æœ‰ä¾èµ–å…³ç³»å°†ä¼šå¹¶è¡Œæ‰§è¡Œã€‚ä¸ºäº†å–æ¶ˆæ‰€æœ‰çš„ä»»åŠ¡,æˆ‘ä»¬åº”è¯¥è°ƒç”¨NSOperation çš„ `cancleAllOperations()` æ–¹æ³•ã€‚åœ¨ ViewController ä¸­æ·»åŠ ä¸€ä¸‹æ–¹æ³•:

    @IBAction func didClickOnCancel(sender: AnyObject) {
            
            self.queue.cancelAllOperations()
        }
åˆ«å¿˜è®°å…³è”åˆšæ‰æ·»åŠ çš„å–æ¶ˆæŒ‰é’®å’Œ`didClickOnCancel` æ–¹æ³•ã€‚ç„¶ååœ¨`didClickOnStart`æ–¹æ³•ä¸­æ·»åŠ ä¾èµ–å…³ç³»:

    operation2.addDependency(operation1)
    operation3.addDependency(operation2)
æ¥ä¸‹æ¥åœ¨ä»»åŠ¡#1ä¸­æ‰“å°å–æ¶ˆçŠ¶æ€:
    operation1.completionBlock = {
                print("Operation 1 completed, cancelled:\(operation1.cancelled) ")
            }
åŒæ ·åº”è¯¥è®°å½•#2#3#4çš„çŠ¶æ€,ä»¥ä¾¿å¯ä»¥çœ‹å‡ºæ‰§è¡Œè¿‡ç¨‹ã€‚ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­è¿è¡Œã€‚åœ¨ç‚¹å‡»äº†å¼€å§‹æŒ‰é’®å,æŒ‰ä¸‹å–æ¶ˆæŒ‰é’®ã€‚è¿™å°†ä¼šåœ¨#1å®Œæˆåå–æ¶ˆæ‰€æœ‰çš„ä»»åŠ¡ã€‚

- ä»»åŠ¡#1 å·²ç»è¢«æ‰§è¡Œ,å–æ¶ˆä¸ä¼šè¢«æ‰§è¡Œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‰“å°äº†å–æ¶ˆçŠ¶æ€ä¸ºå¤±è´¥, app ä»ç„¶ä¼šåŠ è½½å›¾ç‰‡#1ã€‚
- å¦‚æœç‚¹å‡»å–æ¶ˆæŒ‰é’®è¶³å¤Ÿå¿«,#2ä»»åŠ¡æŒ¥åˆ«å–æ¶ˆã€‚`cancelAllOpers()` å°†ä¼šé˜»æ­¢#2ä»»åŠ¡çš„æ‰§è¡Œ,å› æ­¤#2å›¾ç‰‡æ²¡æœ‰è¢«ä¸‹è½½ã€‚
- #3ä»»åŠ¡å·²ç»è¢«æ·»åŠ åˆ°äº†é˜Ÿåˆ—ä¸­,ç­‰å¾…#2å®Œæˆã€‚ä½†æ˜¯#2è¢«å–æ¶ˆäº†,å› æ­¤#3ä»»åŠ¡å°†ä¸ä¼šè¢«æ‰§è¡Œå¹¶ä¸”ä¼šè¢«ä»é˜Ÿåˆ—ä¸­å–å‡ºã€‚
- ç”±äºæ²¡æœ‰å¯¹ä»»åŠ¡#4è¿›è¡Œé…ç½®,å› æ­¤å®ƒå°†ä¼šä¸€æ­¥æ‰§è¡Œä¸‹è½½ä»»åŠ¡ã€‚

![](http://www.appcoda.com/wp-content/uploads/2015/10/ios-concurrency-cancel-demo.png)
## æ¥ä¸‹æ¥è¦åšçš„?
åœ¨æœ¬æ•™ç¨‹ä¸­,æˆ‘å·²ç»å¸®ä½ äº†è§£äº† iOS å¹¶å‘çš„æ¦‚å¿µ,å¹¶å‘Šè¯‰äº†ä½ å¦‚ä½•å®ç°ã€‚æˆ‘å·²ç»ä»‹ç»äº†å¹¶å‘,è§£é‡Šäº† GCD å¹¶ä¸”å±•ç¤ºæ€ä¹ˆå»åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—ã€‚æˆ‘ä»¬ä¹ŸæåŠäº†NSOperationQueuesã€‚
ä¸ºäº†æ›´æ·±å…¥çš„ç†è§£ iOS å¹¶å‘å˜æˆ,æˆ‘å»ºè®®ä½ å­¦ä¹ [Apple's Concurrency Guide](https://developer.apple.com/library/ios/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html)ã€‚
ä½ å¯ä»¥ä¸‹è½½å®Œæ•´çš„ä»£ç [iOS å¹¶å‘ç¼–ç¨‹](https://github.com/appcoda/NSOperation-Demo)ã€‚

