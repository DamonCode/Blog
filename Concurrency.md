# iOS 多线程编程：使用 NSOperation 和 GCD 进行多线程编程
在 iOS 开发中,并发通常被视作"洪水猛兽"。许多开发者认为这是"危险地带",因此都极力避免使用它。传闻多线程代码应该尽你所能去避免使用。我也认为在你没有很好掌握并发编程的时候,这的确是一个"危险地带"。它的不安全来源于你的无知。想象一下,在人们的一生中,也要面临很多的危险活动,不是么?但是一旦人们掌握了它(技巧),你将能很好的使用它。并发编程拥有两面性,因为你应该掌握如何去使用它。它帮助你构建出有执行效率高,快速的应用,同时,滥用也会导致是你的应用崩溃。这就是为什么在开始使用并发编程技术之前你应该了解哪些 API 可以用来解决问题。在iOS 中有不同的APIs 可供使用。在这篇教程中我们将会介绍我们经常使用的两种 APIs ---- NSOperation 和 Dispatch Queues。 
## 为什么要使用并发?
我知道你是一个有丰富经验的 iOS 开发者。无论你将要开发什么类型的 apps ,你都需要知道并发编程可以是你的应用运行的更快更高效。以下我简要列举几个使用并发的有点:
* **充分利用 iOS 的硬件** : 现在所有的 iOS设备都拥有多核处理器, 这就允许开发者可以并行执行多个任务。所以你应该充分利用这一点(多核处理器),发挥硬件的优势。
* **更好的用户体验**:有时候你会去调用网络服务,进行一些 IO 操作, 或者执行一些其它繁重的事务。如你所知, 在 UI 线程(main thread)做这些操作将会阻塞你的应用, 是程序失去响应。曾经用户面对过这个问题,
他会立马杀掉应用进程。使用多线程,所有这些事务都可以在后台线程完成无需阻塞主线程以及妨碍用户操作。用户可以同时点击按钮,滑动操作应用。
* **NSOpetion 和 GCD 的 APIs 使得多线程编程变得更加简单**:创建和管理线程是一件不容易的任务。这也就是为什么大多数的开发者听到多线程以及并发的时候感到恐惧的原因。在 iOS 开发中, 我们有很多优雅易用的并发 APIs。你无须关心底层如何实现创建或者管理线程。这些 APIs 将会为你做好一切。另外一个重要的优势就是,这些 APIs 帮你完成同步操作来避免竞态条件的发生。当多线程操作一份共享的数据时候可能会发生竞态条件,从而导致意想不到的结果。通过使用synchronization 来保护在多线程之间共享的资源。
## 关于并发你应该知道哪些?
在本教程中, 我们将会向你解释所有你应该掌握理解以及困惑你的知识点。首先我推荐了解 blocks(Swift中的闭包),因为在并发的 APIs 中大量使用到了。然后我们将会讲解 GCD 和 NSOpertionQueues 。我们将会讲解他们的概念,不同以及如何去实现。
## 第一部分:GCD (Grand Central Dispatch)
GCD 最常使用用来管理并发,执行异步任务的 API , GCD 提供以及管理着任务队列。首先, 让我们来看看都有哪些队列。
### 队列是什么?
队列是一种管理对象先入先出(FIFO)的数据结构。队列类似于电影院购票窗口排队的人群。 电影票以先到先被服务的形式进行售卖。队列前边的人比后边的人先买到票。计算机中队列也是类似的,因为先添加进队列的元素首先被移除。
![](http://www.appcoda.com/wp-content/uploads/2015/10/queue-line-2-1166050-1280x960.jpg)
### Dispatch Queues
Dispatch Queues 可以让你在你的应用中很便捷的使用异步以及并发。你的应用以 blocks 的形式来调用这些队列。有两种形式的 dispatch queues：(1)serial queue(串行队列)，以及(2)concurrent queues(并发队列)。在讨论两者的不同之前，亦需要首先知道任务被分配在单独的线程执行，而不是创建线程的线程。也就是说，假如你在主线程创建 dispatch queues，这些任务会在运行的其他的线程上，而不是主线程上。
### Serial Queues
当你选择使用串行队列，这种队列只能同时执行一个任务。在一个串行队列中的所有任务都会按顺序执行。然而，他们不关心在其他线程上的任务，也就是说你可以使用多个串行队列。比如，你可以创建两个穿行队列，每一个队列同一时间只能执行一个任务，但是两个任务(不同线程上的)可以同时被执行(并发)。
串行队列对于管理共享的资源来说简直太棒啦！对于共享的资源，它提供了按序的保障来避免"竞态条件"的发生。想象一下，有一大群要买电影票的人，但是只有一个售票厅，在这个例子中，售票员就是共享的资源。一个人同时服务这么多人简直太糟了。为了解决这种窘境，就要求买票的排成一个队列(serial queue)，以便售票员同一时间只服务一个人。
再次强调，这并不意味着电影院同时只能服务一个人。如果新开放了两个的柜台，那么就可以同时服务三个顾客。这就是所说的通过使用多个串行队列来实现同时可以执行多任务。
串行队列的优势：
 1.  对共享资源有序的访问可以避免"竞态条件";
 2.  任务在可控的秩序下执行。当你递交一个任务到串行队列，它们将会按照你添加的队列被执行。
 3.  你可以创建任意数量的串行队列。
 ### Concurrent Queues
 正如名字一样，并发队列允许同时执行多个任务。任务在他们被添加到的队列上有序执行。但是他们的执行可以同时进行并且无需等待其他任务直接执行。并发队列以同一个次序下执行，但是你不知道执行的具体次序，执行时间以及有几个任务在同时执行。
 举个栗子，并发队列执行三个任务(任务#1，任务#2，任务#3)。这些任务在队列中以他们添加的顺序同时执行，然而，执行时间以及结束时间是不同的。即时#2和#3任务开始耗费了一些时间，他们依然可以先于#1任务完成。这是由操作系统来决定的。
 ### 使用队列
 现在我们已经解释了串行和并行队列，该了解如何使用它们了！系统给每一个应用默认提供一个串行队列以及四个并行队列。主队列是运行在主线程上全局可用的串行队列;它被用来更新 app UI 以及和 UIView 更新相关的操作。主队列只能同时执行一个任务，这就是为什么在主线程上执行繁重的任务会阻塞你的 UI 操作。
 除了主队列, 系统还提供了四个并发队列。我们称之为 `Global Dispatch     Queue` 。这些队列在应用程式中是全局的，并且只在优先级上有区别。使用这些全   局队列，你需要使用以下值来指定 `dispatch_get_global_queue` 的第一个参数:
* `DISPATCH_QUEUE_PRIORITY_HIGH`
* `DISPATCH_QUEUE_PRIORITY_DEFAULT`
* `DISPATCH_QUEUE_PRIORITY_LOW`
* `DISPATCH_QUEUE_PRIORITY_BACKGROUND`
这些队列类型相当于执行的优先级。HIGH 具备最高优先级，BACKGROUND 拥有最低的优先级。因此你可以以此来决定你所使用的队列的优先级。同时请注意，这些队列使用的是 Apple 的 APIS，因此这些队列执行的不仅只有你的任务。
总结, 你可以创建任意数量的串行或者并行队列。在使用并发队列的时候，我强烈建议使用系统提供的四种全局队列，当然你也可以创建你自己的队列。

## CGD 图表
现在你应该对 `dispatch queue` 有了初步的理解。现在, 我将会给你一个简单的图表供你参考。这个表格很简单, 包含了所有你需要了解关于 GCD 的知识点。
![](http://www.appcoda.com/wp-content/uploads/2015/10/gcd-cheatsheet.png)

非常 cool，对吧？现在让我们编写一个简单的 demo 来了解如何使用 dispatch queues 。我将会展示给你如何使用 dispatch queues 来优化一个 app 的性能 使得其响应更快。
## Demo Project
我们的启动项目非常的简单，我们展示四个 image views ,每一个从指定站点请求一个图片。图片请求在主线程完成。为了展示给你 UI 是如何的响应, 我已经添加了简单的 slider 在图片下边。现在 [下载并运行项目](https://www.dropbox.com/s/lkiasutevec5vx0/ConcurrencyDemoStarter.zip?dl=0)。点击 Start 按钮来开始下载图片,然后拖动 slider 当图片下载的时候。你将会发现 slider 拖不动。
![](http://www.appcoda.com/wp-content/uploads/2015/10/concurrency-demo.png)